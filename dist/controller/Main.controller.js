sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/core/IconPool","sap/m/Dialog","sap/m/DialogType","sap/m/Button","sap/m/ButtonType","sap/m/List","sap/m/StandardListItem","sap/m/Text","sap/m/TablePersoController","sap/ui/model/FilterOperator","Ventas/Vitrinav2/model/cart","Ventas/Vitrinav2/Services/Services","Ventas/Vitrinav2/model/DemoPersoService","Ventas/Vitrinav2/utils/ExcelDownloaderHelper","Ventas/Vitrinav2/model/columns","Ventas/Vitrinav2/model/filterModel","Ventas/Vitrinav2/model/filtrosLote","Ventas/Vitrinav2/model/filtrosMaterial","Ventas/Vitrinav2/model/filtrosEspecie","Ventas/Vitrinav2/model/filtrosCentro","Ventas/Vitrinav2/model/filtrosAlmacen","Ventas/Vitrinav2/model/filtrosCanal"],function(e,t,i,n,o,a,s,r,l,g,c,u,d,p,f,h,m,v,C,y,P,w,D,I,V,M,S){"use strict";return e.extend("Ventas.Vitrinav2.controller.Main",{onInit:function(){S.initializeModel();P.initializeModel();this.getCanalService();this._oTPC=new p({table:this.byId("tablaProductos"),componentName:"demoApp",persoService:v}).activate();this.mGroupFunctions={WERKS:function(e){var t=e.getProperty("WERKS");return{key:t,text:t}},LGORT:function(e){var t=e.getProperty("LGORT");return{key:t,text:t}},CHARG:function(e){var t=e.getProperty("CHARG");return{key:t,text:t}},CATEGORIA:function(e){var t=e.getProperty("CATEGORIA");return{key:t,text:t}}}},getCanalService:async function(){let e=S.initializeModel();const{results:t}=await m.getCanales();S.setProperty("/canales",t);S.updateModel()},onAfterInit:function(e){this.callProductosService(e);P.initializeModel();this.getMatchcodeLotes();this.getNumeroMaterial();this.getEspecies();this.getMatchcodeCentro();this.getMatchcodeAlmacen();y.initializeModel();this._oMultiInputLote=this.getView().byId("loteInput")},onHandlePopUpCanal:function(){this.oDefaultDialog=undefined;if(!this.oDefaultDialog){var e=new sap.m.StandardListItem({title:"Descripci贸n: {filtrosCanal>VTEXT}",description:"C贸digo: {filtrosCanal>VTWEG}"});this.oDefaultDialog=new s({title:"Seleccione canal de distribuci贸n",content:[new sap.m.List({id:"dialogCanal",mode:"SingleSelect",items:{path:"filtrosCanal>/canales",template:e}})],beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Confirmar",press:function(e){this.onConfirmCanal(e)}.bind(this)})});var t=S.getModel();this.oDefaultDialog.setModel(t,"filtrosCanal");this.getView().addDependent(this.oDefaultDialog)}this.oDefaultDialog.setEscapeHandler(e=>{e.reject()});this.oDefaultDialog.open()},onConfirmCanal:function(e){if(this.oDefaultDialog.getContent()[0].getSelectedItem()!==null){let e=this.oDefaultDialog.getContent()[0].getSelectedItem().getProperty("description");let t=e.split(" ");let i=t[1];S.getModel().setProperty("/canalSeleccionado",i);this.oDefaultDialog.close();this.onAfterInit(i)}else{sap.m.MessageToast.show("Por favor, seleccione un canal de distribuci贸n")}},onDataExport:function(e){var t=this.getView().byId("tablaProductos");var i=this.getView().byId("tablaProductos").getColumns();this.onExportTable(t,i)},onExportTable:function(e,t){var i=[];var n=[];for(var o=0;t.length>o;o++){i.push(t[o].getHeader().getText());if(e.getItems().length>0){if(e.getItems()[0].getCells()[o].getBinding("title")!==undefined){n.push(e.getItems()[0].getCells()[o].getBinding("title").getPath())}else if(e.getItems()[0].getCells()[o].getBinding("text")!==undefined){n.push(e.getItems()[0].getCells()[o].getBinding("text").getPath())}}}var a=this.getView().getModel("productos").getData();C.onExport(a,i,n,e)},onSearchMaterial:function(e){var t=[];var i=e.getSource().getValue();if(i&&i.length>0){t.push(new n([new sap.ui.model.Filter("MATNR",f.Contains,i)],false))}var o=this.byId("tablaProductos");var a=o.getBinding("items");a.filter(t,"Application")},handleViewSettingsDialogButtonPressed:function(e){if(!this._oDialog){this._oDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.TableDialog",this)}jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._oDialog);this._oDialog.open()},handleConfirm:function(e){var t=this.getView();var i=t.byId("tablaProductos");var a=e.getParameters();var s=i.getBinding("items");var r;var l;var g;var c=[];if(a.groupItem){r=a.groupItem.getKey();l=a.groupDescending;g=this.mGroupFunctions[r];c.push(new o(r,l,g))}r=a.sortItem.getKey();l=a.sortDescending;c.push(new o(r,l));s.sort(c);var u=[];jQuery.each(a.filterItems,function(e,t){var i=t.getKey().split("___");var o=i[0];var a=i[1];var s=i[2];var r=new n(o,a,s);u.push(r)});s.filter(u);if(a.groupItem!==undefined){this.getView().byId("vsdFilterBar").setVisible(true);this.getView().byId("vsdFilterLabel").setText("Agrupado por: "+a.groupItem.mProperties.text)}else{this.getView().byId("vsdFilterBar").setVisible(false)}},onExit:function(){this._oTPC.destroy()},onPersoButtonPressed:function(e){this._oTPC.openDialog()},onTablePersoRefresh:function(){v.resetPersData().done(function(){this._oTPC.refresh()}.bind(this))},onTableGrouping:function(e){this._oTPC.setHasGrouping(e.getSource().getSelected())},getMatchcodeLotes:async function(){var e=[new n("CHARG","Contains","")];let t=w.initializeModel();const{results:i}=await m.getLotes();t.setProperty("/lotes",i)},onHandleLote:function(){if(!this._oLoteDialog){this._oLoteDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpLote",this);this.getView().addDependent(this._oLoteDialog)}this._oLoteDialog.open()},onLoteDialogSearch:function(e){var t=e.getParameter("value"),i=new n("CHARG",f.Contains,t);e.getSource().getBinding("items").filter([i])},onLoteDialogClose:function(e){var t,i=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!i){return}t=i.getTitle();P.getModel().setProperty("/lote",t)},getNumeroMaterial:async function(){let e=D.initializeModel();const{results:t}=await m.getMateriales();e.setProperty("/materiales",t)},onHandleMaterial:function(){if(!this._oMaterialDialog){this._oMaterialDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpMaterial",this);this.getView().addDependent(this._oMaterialDialog)}this._oMaterialDialog.open()},onMaterialDialogSearch:function(e){var t=e.getParameter("value");var i=new n("MATNR",f.Contains,t);e.getSource().getBinding("items").filter([i])},onMaterialDialogClose:function(e){var t,i=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!i){return}t=i.getTitle();P.getModel().setProperty("/material",t)},getMatchcodeCentro:async function(){let e=V.initializeModel();const{results:t}=await m.getCentros();e.setProperty("/centros",t)},onHandleCentro:function(){if(!this._oCentroDialog){this._oCentroDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpCentro",this);this.getView().addDependent(this._oCentroDialog)}this._oCentroDialog.open()},onCentroDialogSearch:function(e){var t=e.getParameter("value"),i=new n("WERKS",f.Contains,t);e.getSource().getBinding("items").filter([i])},onCentroDialogClose:function(e){var t,i=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!i){return}t=i.getTitle();P.getModel().setProperty("/centro",t)},getMatchcodeAlmacen:async function(){let e=M.initializeModel();const{results:t}=await m.getAlmacenes();e.setProperty("/almacenes",t)},onHandleAlmacen:function(){if(!this._oAlmacenDialog){this._oAlmacenDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpAlmacen",this);this.getView().addDependent(this._oAlmacenDialog)}this._oAlmacenDialog.open()},onAlmacenDialogSearch:function(e){var t=e.getParameter("value"),i=new n("LGORT",f.Contains,t);e.getSource().getBinding("items").filter([i])},onAlmacenDialogClose:function(e){var t,i=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!i){return}t=i.getTitle();P.getModel().setProperty("/almacen",t)},getEspecies:async function(){var e=[new n("ESPECIE","Contains","")];let t=I.initializeModel();const{results:i}=await m.getEspecies(e);t.setProperty("/especies",i)},onHandleEspecie:function(){if(!this._oEspecieDialog){this._oEspecieDialog=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpEspecie",this);this.getView().addDependent(this._oEspecieDialog)}this._oEspecieDialog.open()},onEspecieDialogSearch:function(e){var t=e.getParameter("value"),i=new n("ESPECIE",f.Contains,t);e.getSource().getBinding("items").filter([i])},onEspecieDialogClose:function(e){var t,i=e.getParameter("selectedItem");e.getSource().getBinding("items").filter([]);if(!i){return}t=i.getTitle();P.getModel().setProperty("/especie",t)},onValueHelpRequested:function(){var e=y.getModel().getData().cols;this._oValueHelpDialogLote=sap.ui.xmlfragment("Ventas.Vitrinav2.view.dialogs.valueHelpLote",this);this.getView().addDependent(this._oValueHelpDialogLote);this._oValueHelpDialogLote.getTableAsync().then(function(t){t.setModel(w.getModel());t.setModel(y.getModel(),"columns");if(t.bindRows){t.bindAggregation("rows","/lotes")}if(t.bindItems){t.bindAggregation("items","/lotes",function(){return new ColumnListItem({cells:e.map(function(e){return new Label({text:"{"+e.template+"}"})})})})}this._oValueHelpDialogLote.update()}.bind(this));this._oValueHelpDialogLote.setTokens(this._oMultiInputLote.getTokens());this._oValueHelpDialogLote.open()},onValueHelpOkPress:function(e){var t=e.getParameter("tokens");this._oMultiInputLote.setTokens(t);this._oValueHelpDialogLote.close()},onValueHelpCancelPress:function(){this._oValueHelpDialogLote.close()},callProductosService:async function(e){var t=[];t.push(new sap.ui.model.Filter("VTWEG",sap.ui.model.FilterOperator.EQ,e));try{var i=this.getView().byId("tablaProductos");i.setBusy(true);const e=await this.readProductosService(t);if(e.results.length>0){e.results.forEach((t,i)=>{e.results[i].LABST=Number(t.LABST.trim())});e.results.forEach((t,i)=>{e.results[i].PRECIO=Number(t.PRECIO.trim())})}this.getOwnerComponent().getModel("productos").setProperty("/items",e.results);i.setBusy(false)}catch(e){i.setBusy(false);if(e.responseText!==undefined){let t=JSON.parse(e.responseText).error.message.value;sap.m.MessageToast.show(t)}else{sap.m.MessageToast.show("Error")}}},callProductosServiceFiltering:async function(){var e=this.getView().byId("tablaProductos");try{var t=`/sap/opu/odata/sap/zod_pedido_srv/PEDIDOSet?$inlinecount=allpages`;if(P.getModel().getData().filters!==""){t+=P.getModel().getData().filters}var i=await fetch(t,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});e.setBusy(true);var n=await i.json();var e=this.getView().byId("tablaProductos");if(n.d.results.length>0){n.d.results.forEach((e,t)=>{n.d.results[t].LABST=Number(e.LABST.trim())});n.d.results.forEach((e,t)=>{n.d.results[t].PRECIO=Number(e.PRECIO.trim())})}this.getOwnerComponent().getModel("productos").setProperty("/items",n.d.results);e.setBusy(false)}catch(t){e.setBusy(false);if(t.responseText!==undefined){let e=JSON.parse(t.responseText).error.message.value;sap.m.MessageToast.show(e)}else{sap.m.MessageToast.show("Error")}}},readProductosService:function(e){return new Promise((t,i)=>{this.getOwnerComponent().getModel("pedidos").read("/PEDIDOSet",{filters:e,success:t,error:i})})},isThereMoreData:function(){const e=this.getOwnerComponent().getModel("pagination").getData();if(e.pagination.changing){return false}if(e.pagination.currentPage===0){return true}const t=e.pagination.availableData-e.pagination.currentPage*e.pagination.$top>0;return t},async addToCart(e){var t=e.getSource();t.setEnabled(false);t.setBusy(true);try{var n="productos";var o=this._instantiateItem(e.getSource().getBindingContext(n).getObject());var a=this.getOwnerComponent().getModel("cart");if(!a.getData().isDuplicate(o)){var s=await this.fetchCurrentStock(o);o.updateStock(s);var r=await this._quantityInput();o.changeQuantity(r);o.calculateTax()}if(a.getData().addItem(o)){var l=this.getOwnerComponent().getModel("i18n").getProperty("mainCartAddingSuccess");sap.m.MessageToast.show(l,{my:"center center",at:"center center"})}}catch(e){debugger;var g=this.getOwnerComponent().getModel("i18n").getProperty("mainCartFailedToAddtitle");if(e!=this.getOwnerComponent().getModel("i18n").getProperty("cancelledFromPromise")){i.warning(e.message,{icon:sap.m.MessageBox.Icon.WARNING,title:g})}}finally{t.setEnabled(true);t.setBusy(false)}},_instantiateItem:function(e){var t=vitrinaShopCart().Item(e.MATNR,e.WERKS,e.LGORT,e.CHARG,e.PRECIO,e.MONEDA,e.LABST,e.MAKTX,e.IMPORTE,e.MEINS,e.CALIBRE,e.MARCA,e.IVA);return t},_quantityInput:function(){var e=this.getOwnerComponent().getModel("i18n").getProperty("mainQuantityInputPopUp");var t=this.getOwnerComponent().getModel("i18n").getProperty("mainQuantitySubmitButtonPopUp");var i=this.getOwnerComponent().getModel("i18n").getProperty("mainQuantityCancelButtonPopUp");var n=this.getOwnerComponent().getModel("i18n").getProperty("cancelledFromPromise");const o=function(o,a){var s=0;var r=false;const l=()=>{s=Number(g.getValue());c.close()};var g=new sap.m.Input("quantityInput",{type:sap.m.InputType.Number,submit:l});var c=new sap.m.Dialog({title:e,type:"Message",content:g,beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:t,press:l}),endButton:new sap.m.Button({text:i,press:()=>{r=true;c.close()}}),afterClose:()=>{c.destroy();if(r){a(n)}o(s)}});c.open()};return new Promise(o)},async fetchCurrentStock(e){var t;try{var i=`/sap/opu/odata/sap/zod_pedido_srv/PEDIDOSet?$filter=`;i+=`MATNR eq '${e.matnr}' `;i+=`and LGORT eq '${e.lgort}' `;i+=`and WERKS eq '${e.werks}' `;i+=`and CHARG eq '${e.charg}'`;i+=`&$select=LABST`;var n=await fetch(i,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var o=await n.json();o.d.results.forEach((e,t)=>{o.d.results[t].LABST=Number(e.LABST.trim())});if(o.d.results.length>0){t=o.d.results[0].LABST}else{t=0}this._refreshAProductStock(e,t)}catch(e){const t=this.getOwnerComponent().getModel("i18n").getProperty("failedToFetchStock");throw new Error(t)}return t},_refreshAProductStock:function(e,t){const i=this.getOwnerComponent().getModel("productos");const n=i.getData().items.findIndex(t=>t.MATNR===e.matnr&&t.LGORT===e.lgort&&t.WERKS===e.werks&&t.CHARG===e.charg);i.getData().items[n].LABST=t;i.refresh(true)},navToCart:function(){this.getOwnerComponent().getModel("cart").refresh(true);var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("cart")},initCart:function(){var e=new t(vitrinaShopCart().Cart());this.getOwnerComponent().setModel(e,"cart")},_noConnection:function(){const e=this.getOwnerComponent().getModel("i18n").getProperty("noConnectivity");const t=this.getOwnerComponent().getModel("i18n").getProperty("noConnectivityTitle");i.error(e,{icon:sap.m.MessageBox.Icon.ERROR,title:t})},onFilter:function(e){var t={};var i;if(e.getSource()instanceof sap.m.Input){i=e.getSource().getParent().getParent().getParent().getAllFilterItems()}else{i=e.getSource().getAllFilterItems()}i.forEach(e=>{t[e.getName()]=e.getControl().getValue()});this.applyFilter(t)},applyFilter:function(e){var t=S.getModel().getProperty("/canalSeleccionado");const i={almacen:"LGORT",calibre:"CALIBRE",centroLogistico:"WERKS",especie:"ESPECIE",numeroMaterial:"MATNR",variedad:"VARIEDAD",lote:"CHARG",classification:"CLASIFICACION_F_V"};var n="&$filter=";for(var[o,a]of Object.entries(e)){if(a!==""&&o==="lote"){const e="(10)";const t=a.indexOf(e);if(t>0){a=a.substring(t+e.length,a.length);const i=a.split("");var s=0;i.forEach((e,t)=>s=e!=="0"&&s===0?t:s);a=a.substring(s,a.length)}n+=n==="&$filter="?`substringof('${a}', ${i[o]})`:` and substringof('${a}', ${i[o]})`}else if(a!==""){n+=n==="&$filter="?`substringof('${a}', ${i[o]})`:` and substringof('${a}', ${i[o]})`}}if(n==="&$filter="){n=n+`VTWEG eq '${t}'`}else{n=n+`and VTWEG eq '${t}'`}P.setProperty("/filters",n);this.callProductosServiceFiltering()},clearFilters:function(){this.byId("filterCharg").setValue("");this.byId("material").setValue("");this.byId("filterEspecie").setValue("");this.byId("filterCentro").setValue("");this.byId("filterAlmacen").setValue("");this.byId("filterVariedad").setValue("");this.byId("filterCalibre").setValue("");this.byId("filterClassification").setValue("")},initializePagination:function(){const e={pagination:{$top:100,$skip:0,currentPage:0,availableData:0,changing:false},filters:""};var i=new t(e);this.getOwnerComponent().setModel(i,"pagination")},onGrowTable:function(e){const t=this.byId("myScrollContainer").getDomRef();const i=t.clientHeight*1.2;const n=t.scrollHeight-t.scrollTop;const o=n<=i;if(o)this.fetchProductos()},reset:function(){this.initializePagination();this.getOwnerComponent().setModel(undefined,"productos")},onSuggest:async function(e){if(e.getParameters().suggestValue===""){return}const t={filterCalibre:"CALIBRE",filterEspecie:"ESPECIE",filterVariedad:"VARIEDAD",filterCharg:"CHARG",filterClassification:"CLASIFICACION_F_V"};var i=e.getParameter("suggestValue");var n=[];if(i){n.push(new sap.ui.model.Filter("text",sap.ui.model.FilterOperator.Contains,i))}const o=e.getSource();const a=t[o.getName()];const s=e.getParameters().suggestValue;const r="(10)";await this.fetchSuggestions(a,s);o.setFilterSuggests(false);o.getBinding("suggestionItems").filter(n)},fetchSuggestions:function(e,i){const n=async function(n,o){try{var a=`/sap/opu/odata/sap/zod_pedido_srv/PEDIDOSet?$select=${e}&$filter=substringof('${i}',${e}) and GROUPBY eq ''&$top=5`;var s=await fetch(a,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var r=await s.json();var l=[];r.d.results.forEach(t=>{l.push({text:t[e]})});var g=new t(l);const o="suggestions"+e;this.getOwnerComponent().setModel(g,o);this.getOwnerComponent().getModel(o).refresh(true);n(true)}catch(e){this._noConnection();o("No connection")}}.bind(this);return new Promise(n)},onAfterRendering:function(){this.onHandlePopUpCanal();this.initCart()}})});