sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/m/MessageBox","./../model/cart","./../model/cliente"],function(e,t,n,o){"use strict";return e.extend("Ventas.Vitrinav2.controller.cart",{onInit:function(){this._instantiateClient();var e=this.byId("rutCliente");e.onsapenter=e=>{this.fetchClient()}},onNavBack:function(){var e=n.getInstance();var t=e.getPreviousHash();var o=sap.ui.core.UIComponent.getRouterFor(this);if(t!==undefined){window.history.go(-1)}else{o.navTo("main",true)}},quantityChange:function(e){this._clearControlValueState(e.getSource());var t=e.getSource().getBindingContext("cart").getObject();try{var n=e.getSource().getValue();t.changeQuantity(n);t.calculateTotal()}catch(n){e.getSource().setValueState(sap.ui.core.ValueState.Error);e.getSource().setValueStateText(n.message);t.calculateTotal(0)}const o=this.getOwnerComponent().getModel("cart");this._refreshCartModel()},onDiscountTextChange:function(e){this._clearControlValueState(e.getSource());try{var t=e.getSource().getBindingContext("cart").getObject();var n=e.getSource().getValue();const o=e.getSource().getParent();const i=o.getItems()[0];const a=this._getOperator(i.getIcon());this._discountChange(t,n,a)}catch(t){e.getSource().setValueState(sap.ui.core.ValueState.Error);const n=this.getOwnerComponent().getModel("i18n").getProperty("cartInvalidDiscount");e.getSource().setValueStateText(n)}this._refreshCartModel()},onDiscountOperatorChange:function(e){const t=e.getSource();this._changeButtonIcon(t);try{var n=e.getSource().getBindingContext("cart").getObject();const o=e.getSource().getParent();const i=o.getItems()[1];const a=i.getValue();const s=this._getOperator(t.getIcon());this._discountChange(n,a,s)}catch(e){}this._refreshCartModel()},_getOperator:function(e){const t=[{icon:`sap-icon://add`,operator:"+"},{icon:`sap-icon://less`,operator:"-"}];return t.filter(t=>t.icon===e).map(e=>e.operator)[0]},_changeButtonIcon:function(e){const t=`sap-icon://add`;const n=`sap-icon://less`;var o;if(e.getIcon()===t){o=n}else{o=t}e.setIcon(o)},_discountChange:function(e,t,n){const o=Number(t);e.changeDiscount(o);e.changeDiscountOperator(n);e.calculateTotal();e.changeDisplayPrice()},_refreshCartModel:function(){const e=this.getOwnerComponent().getModel("cart");if(!e)return;this._calculateEverything(e);e.refresh(true)},removeFromCart:function(e){var t=this.getOwnerComponent().getModel("cart");var n="cart";var o=e.getSource().getBindingContext(n).getObject();t.getData().removeItem(o);this._calculateEverything(t);this.getOwnerComponent().getModel("cart").refresh(true)},_calculateEverything:function(e){e.getData().calculateTax();e.getData().calculateNetTotal();e.getData().calculateBoxCount();e.getData().calculatePerceptionTax();e.getData().calculateTotal();e.refresh(true)},async fetchClient(e){var t=this.byId("rutCliente");t.setEnabled(false);this._clearControlValueState(t);var n=this.byId("searchClient");n.setEnabled(false);try{const n=typeof e==="string"?e:t.getValue();t.setValue(n);var o=`/sap/opu/odata/sap/zod_pedido_srv/CLIENTESet?$filter=ID eq '${n.trim()}'`;var i=await fetch(o,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var a=await i.json();var s=this.byId("mutateClient");var r;if(a.d.results.length>0){a.d.results[0].ID=t.getValue();this._instantiateClient(a.d.results[0]);s.setEnabled(false)}else{t.setValueState(sap.ui.core.ValueState.Error);const e=this.getOwnerComponent().getModel("i18n").getProperty("cartClientNotFound");t.setValueStateText(e);this._instantiateClient();s.setEnabled(true)}}catch(e){this._noConnection()}t.setEnabled(true);n.setEnabled(true)},_instantiateClient:function(e="empty"){var n;if(e==="empty"){var n=vitrinaShopClient().Cliente({ID:"",KUNNR:"N/A",NAME1:"N/A",NAME2:"N/A",ZTERM:"N/A",STRAS:"N/A",ORT01:"N/A",REGIO:"N/A"})}else{n=vitrinaShopClient().Cliente(e)}var o=new t(n);o.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);this.getOwnerComponent().setModel(o,"cliente");this.getOwnerComponent().getModel("cliente").refresh(true)},async _fetchXCSRFToken(){try{var e=`/sap/opu/odata/sap/zod_pedido_srv/CLIENTESet?$filter=ID eq 1`;var t=await fetch(e,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});const n=t.headers.get("X-CSRF-Token");return n}catch(e){this._noConnection()}},validarEnvio:function(){var e=true;var t=this.getOwnerComponent().getModel("cart");if(t){t=t.getData();if(t.items.length===0){e=false;return e}t.items.forEach(t=>{const n=t.validate();if(!n.isValidQuantity||!n.isValidDiscount){this._setInvalidInputOnTable(t,n);e=false}})}else{e=false}const n=this.getOwnerComponent().getModel("cliente").getData();if(!n.validate()){this._setInvalidInputOnClient();e=false}if(!t.isValidInvoiceType()){this._setInvalidInvoice();e=false}if(!t.isValidDeliveryType()){this._setInvalidDelivery();e=false}const i="CPD";const a=this.byId("invoiceType");const s=n.id==="";if(a.getSelectedItem().getText().indexOf(i)>0&&n.secondId===""&&s){o.error(this.getOwnerComponent().getModel("i18n").getProperty("missingSecondFiscalIdentifier"),{icon:sap.m.MessageBox.Icon.ERROR,title:this.getOwnerComponent().getModel("i18n").getProperty("missingSecondFiscalIdentifierTitle")});e=false}return e},_setInvalidInputOnTable:function(e,t){var n=this.byId("tablaProductos");n.getItems().forEach(n=>{const o=n.getBindingContext("cart").getObject();if(o.equals(e)){n.getCells().forEach(e=>{if(e instanceof sap.m.Input){var n=e.getName()==="quantity";if(n&&!t.isValidQuantity){e.setValueState(sap.ui.core.ValueState.Error);const t=this.getOwnerComponent().getModel("i18n").getProperty("cartInvalidQuantity");e.setValueStateText(t)}var o=e.getName()==="discount";if(o&&!t.isValidDiscount){e.setValueState(sap.ui.core.ValueState.Error);const t=this.getOwnerComponent().getModel("i18n").getProperty("cartInvalidDiscount");e.setValueStateText(t)}}})}})},_setInvalidInputOnClient:function(){const e=this.byId("rutCliente");e.setValueState(sap.ui.core.ValueState.Error);const t=this.getOwnerComponent().getModel("i18n").getProperty("cartNoClientAssigned");e.setValueStateText(t)},_setInvalidInvoice:function(){const e=this.byId("invoiceType");e.setValueState(sap.ui.core.ValueState.Error);const t=this.getOwnerComponent().getModel("i18n").getProperty("cartNoInvoiceAssigned");e.setValueStateText(t)},_setInvalidDelivery:function(){const e=this.byId("deliveryType");e.setValueState(sap.ui.core.ValueState.Error);const t=this.getOwnerComponent().getModel("i18n").getProperty("cartNoDeliveryAssigned");e.setValueStateText(t)},promptSendConfirmation:function(){if(!this.validarEnvio()){return}const e=this.getOwnerComponent().getModel("i18n").getProperty("saveOrderSaveOption");const t=this.getOwnerComponent().getModel("i18n").getProperty("saveOrderEraseOption");o.success(this.getOwnerComponent().getModel("i18n").getProperty("promptSendMessage"),{icon:sap.m.MessageBox.Icon.INFORMATION,title:this.getOwnerComponent().getModel("i18n").getProperty("promptSendTitle"),actions:[e,t,sap.m.MessageBox.Action.CANCEL],emphasizedAction:e,onClose:n=>{if(n===e)this.postPurchaseDetails();if(n===t)this.promptConfirmResetByUser()}})},async postPurchaseDetails(){if(this.getOwnerComponent().getModel("cart").getData().sendingToServer){return}if(!this.validarEnvio()){return}await this._promptOutsideToleranceWarning(this._findItemsOutsideTolerance());this.getView().setBusy(true);this.getOwnerComponent().getModel("cart").getData().sendingToServer=true;try{const s=await this._fetchXCSRFToken();var e=`/sap/opu/odata/sap/zod_pedido_srv/HEADERSet`;var t=await fetch(e,{method:"POST",headers:{"x-csrf-token":s,Accept:"application/json","Content-Type":"application/json; charset=utf-8"},body:JSON.stringify(this._conformToPurchaseDetailsModel())});var{d:n}=await t.json();const r="E";const c="CREADO";const l="RECHAZADO";var i="";var a=this.getOwnerComponent().getModel("i18n").getProperty("cartOrderSucess")+" ";n.NAVRESULTADO.results.forEach(e=>{if(e.MSG1===r){i+=i===""?e.MSG2:`\n${e.MSG2}`}else if(e.MSG1===c){a+=e.MSG2}else if(e.MSG1===l){i+=i===""?e.MSG2:`\n${e.MSG2}`}});if(i===""){o.success(a,{icon:sap.m.MessageBox.Icon.SUCCESS,title:this.getOwnerComponent().getModel("i18n").getProperty("cartOrderSuccessTitle"),onClose:e=>{this.resetAfterSuccess()}})}else{o.error(i,{icon:sap.m.MessageBox.Icon.ERROR,title:this.getOwnerComponent().getModel("i18n").getProperty("cartOrderFailureTitle")})}}catch(e){this._noConnection()}this.getView().setBusy(false);this.getOwnerComponent().getModel("cart").getData().sendingToServer=false},_conformToPurchaseDetailsModel:function(){const e=[];const t=this.getOwnerComponent().getModel("cart").getData();t.items.forEach((t,n)=>{var o=0;if(t.discount!==0){o=t.discount;if(t.discountOperator==="-"){o=t.discount*-1}else{o=t.discount}}const i={ICAMPO1:(n+1).toString().trim(),ICAMPO2:t.matnr.toString().trim(),ICAMPO3:t.quantity.toString().trim(),ICAMPO4:t.werks.toString().trim(),ICAMPO5:t.netPrice.toString().trim(),ICAMPO6:t.currency.toString().trim(),ICAMPO7:t.charg.toString().trim(),ICAMPO8:o.toString().trim(),ICAMPO9:t.lgort.toString().trim()};e.push(i)});const n=this.getOwnerComponent().getModel("cliente").getData();var o;const i=n.id==="";if(!i){o={d:{CAMPO1:n.id,CAMPO6:t.invoiceType,CAMPO7:t.deliveryType,ITEMSet:e,NAVRESULTADO:[]}}}else{o={d:{CAMPO1:n.id,CAMPO2:n.rut,CAMPO3:n.phone,CAMPO4:n.street,CAMPO5:n.name1,CAMPO6:t.invoiceType,CAMPO7:t.deliveryType,CAMPO8:n.secondId,ITEMSet:e,NAVRESULTADO:[]}}}return o},navToClient:function(){var e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Client")},_noConnection:function(){const e=this.getOwnerComponent().getModel("i18n").getProperty("noConnectivity");const t=this.getOwnerComponent().getModel("i18n").getProperty("noConnectivityTitle");o.error(e,{icon:sap.m.MessageBox.Icon.ERROR,title:t})},_refreshClientModel:function(){this.getOwnerComponent().getModel("cliente").refresh(true);const e=this.byId("rutCliente");this._clearControlValueState(e)},resetAfterSuccess:function(){this.getOwnerComponent().getModel("cart").getData().items=[],this.getOwnerComponent().getModel("cart").getData().total=0;this.getOwnerComponent().getModel("cart").getData().tax=0;this.getOwnerComponent().getModel("cart").getData().netTotal=0;this._instantiateClient();this.byId("invoiceType").setSelectedKey("default");this.byId("deliveryType").setSelectedKey("default");this.byId("rutCliente").setValue("");this.onNavBack()},promptConfirmResetByUser:function(){o.success(this.getOwnerComponent().getModel("i18n").getProperty("promptEraseOrderMessage"),{icon:sap.m.MessageBox.Icon.INFORMATION,title:this.getOwnerComponent().getModel("i18n").getProperty("promptEraseOrderTitle"),actions:[sap.m.MessageBox.Action.DELETE,sap.m.MessageBox.Action.CANCEL],emphasizedAction:sap.m.MessageBox.Action.CANCEL,onClose:e=>{if(e===sap.m.MessageBox.Action.DELETE)this.resetAfterSuccess()}})},_findItemsOutsideTolerance:function(){var e=[];const t=this.getOwnerComponent().getModel("cart").getData();t.items.forEach(t=>{const n=t.quantity;const o=t.discount<0?t.discount*-1:t.discount;const i=this._isWithinTolerance(n,o);if(!i.isAcceptable){t.tolerance=i.tolerance;e.push(t)}});return e},_isWithinTolerance:function(e,t){const n=this.getOwnerComponent().getModel("tolerance").getData();var o=0;n.forEach(t=>{if(e<=t.priceBracket)o=t.maximumDiscount});var i={isAcceptable:t<=o,tolerance:o};return i},_promptOutsideToleranceWarning:function(e){const t=this.getOwnerComponent().getModel("i18n").getProperty("toleranceTitle");const n=sap.m.MessageBox.Icon.WARNING;const i=this.getOwnerComponent().getModel("i18n").getProperty("maxDiscountApplicable");var a=this.getOwnerComponent().getModel("i18n").getProperty("toleranceMessage");e.forEach(e=>{a+=`\n${e.description} ${e.marca} \n\t\t\t\t\t\t\t${i}: ${e.tolerance}\n`});const s=this.getOwnerComponent().getModel("i18n").getProperty("acceptButton");const r=function(i,r){if(e.length===0){i(true)}else{o.error(a,{icon:n,title:t,actions:[s,o.Action.CANCEL],emphasizedAction:o.Action.CANCEL,onClose(e){if(e===s){i(true)}else{r("Cancelled by user")}}})}};return new Promise(r)},async fetchTolerance(e=0){try{const e=`/sap/opu/odata/sap/zod_pedido_srv/TOLERANCIASet`;var n=await fetch(e,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var o=await n.json();var i=[];o.d.results.forEach(e=>{const t={maximumDiscount:Number(e.KBETR.trim()),priceBracket:Number(e.KSTBW.trim())};i.push(t)});i.sort(function(e,t){return t.priceBracket-e.priceBracket});var a=new t(i);this.getOwnerComponent().setModel(a,"tolerance")}catch(t){if(e!=3){this.fetchTolerance(e++)}else{this._noConnection()}}},async fetchInvoiceType(e=0){try{const e=`/sap/opu/odata/sap/zod_pedido_srv/TIPO_FACTURASet`;var n=await fetch(e,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var o=await n.json();var i=[{type:"default",description:this.getOwnerComponent().getModel("i18n").getProperty("defaultInvoice"),perceptionTax:0}];o.d.results.forEach(e=>{const t={type:e.KONDA.trim(),description:e.VTEXT.trim(),perceptionTax:Number(e.KBETR.trim())};i.push(t)});var a=new t(i);this.getOwnerComponent().setModel(a,"invoiceType")}catch(t){if(e!=3){this.fetchTolerance(e++)}else{this._noConnection()}}},async fetchDeliveryOptions(e=0){try{const e=`/sap/opu/odata/sap/zod_pedido_srv/DESPACHOSet`;var n=await fetch(e,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var o=await n.json();var i=[{type:"default",description:this.getOwnerComponent().getModel("i18n").getProperty("defaultDelivery")}];o.d.results.forEach(e=>{const t={type:e.VSBED.trim(),description:e.VTEXT.trim()};i.push(t)});var a=new t(i);this.getOwnerComponent().setModel(a,"deliveryOptions")}catch(t){if(e!=3){this.fetchTolerance(e++)}else{this._noConnection()}}},onInvoiceChange:function(e){this._clearControlValueState(e.getSource());var t=this.getOwnerComponent().getModel("cart");var n=e.getSource().getSelectedItem().getBindingContext("invoiceType").getObject();t.getData().changeInvoiceType(n.type);t.getData().changePerceptionTax(n.perceptionTax);this._calculateEverything(t)},onDeliveryChange:function(e){this._clearControlValueState(e.getSource());var t=this.getOwnerComponent().getModel("cart");var n=e.getSource().getSelectedKey();t.getData().changeDelivertyType(n);this._calculateEverything(t)},_clearControlValueState:function(e){e.setValueState(sap.ui.core.ValueState.None);e.setValueStateText("")},async clientSelectDialog(){const e=(e,t)=>{const n=new sap.m.TableSelectDialog("selectDialog",{cancel(){this.destroy();t("cancelado por el usuario")},confirm:async t=>{const n=t.getParameters().selectedItem.getCells()[0].getText();const o=t.getSource();await this.fetchClient(n);o.destroy();e({yey:true})},search:async e=>{const t=e.getParameters().value.trim();const n=e.getSource();if(t){await this.fetchClientList(t);this.fillClientListTable(n)}}});this._clientSelectCreateColumns(n);n.open()};const t=new Promise(e);await t;console.log("todo ok!")},_clientSelectCreateColumns:function(e){if(e.getColumns().length>0)e.destroyColumns();const t=new sap.m.Column({});const n=this.getOwnerComponent().getModel("i18n").getProperty("cartFiscalIdentifier");t.setHeader(new sap.m.Text({text:n}));e.addColumn(t);const o=new sap.m.Column({});const i=this.getOwnerComponent().getModel("i18n").getProperty("cartName");o.setHeader(new sap.m.Text({text:i}));e.addColumn(o)},async fetchClientList(e){try{const a=this.getOwnerComponent().getModel("clientePagination");var n=`/sap/opu/odata/sap/zod_pedido_srv/CLIENTESet?$inlinecount=allpages&$top=${a.getData().pagination.$top}&$skip=${a.getData().pagination.$skip}&$filter=substringof('${e}', NAME1)`;var o=await fetch(n,{method:"GET",headers:{"x-csrf-token":"fetch",Accept:"application/json","Content-Type":"application/json; charset=utf-8"}});var{d:i}=await o.json();this.getOwnerComponent().setModel(new t(i),"clientList")}catch(e){this._noConnection()}},fillClientListTable:function(e){if(e.getItems().length>0)e.destroyItems();const t=this.getOwnerComponent().getModel("clientList").getData();t.results.forEach(t=>{const n=new sap.m.ColumnListItem;n.insertCell(new sap.m.Text({text:t.ID}),0);n.insertCell(new sap.m.Text({text:t.NAME1}),1);n.insertCell(new sap.m.Text({text:t.STRAS}),2);e.addItem(n)})},initializeClientListPagination:function(){const e={pagination:{$top:100,$skip:0,currentPage:0,availableData:0,changing:false}};var n=new t(e);this.getOwnerComponent().setModel(n,"clientePagination")},onAfterRendering:function(){var e=this.getOwnerComponent().getModel("cart");this.fetchInvoiceType();this.fetchTolerance();this.fetchDeliveryOptions();this.initializeClientListPagination()}})});